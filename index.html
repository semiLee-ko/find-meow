<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Find Meow - TV ì±„ë„ ê³ ì–‘ì´ ì°¾ê¸° ê²Œì„</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="result-layout-patch.css">
</head>

<body>
    <!-- ë¡œê³  -->
    <div class="logo"><img src="images/logo.png" alt="FindMeow Logo"></div>

    <!-- TV í™”ë©´ -->
    <div class="tv-container">
        <div class="tv-screen" id="tvScreen">
            <img class="tv-image" id="tvImage" src="" alt="TV Screen">
            <div class="channel-display" id="channelDisplay">000</div>
            <div class="cat-counter" id="catCounter">0</div>
            <div class="tv-brand">CODA creaTV</div>
        </div>
    </div>

    <!-- ë²½ ì¥ì‹ ì˜ì—­ (ì¶”í›„ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€ ì˜ˆì •) -->
    <div class="wall-decoration-area"></div>

    <!-- ì´ˆê¸° í™”ë©´ (ì°¸ì—¬ ì¸ì› ì„ íƒ) -->
    <div class="initial-screen" id="initialScreen">
        <div class="input-group">
            <label for="playerCount">ì°¸ì—¬ ì¸ì› ìˆ˜</label>
            <select id="playerCount">
                <option value="1">1ëª…</option>
                <option value="2">2ëª…</option>
                <option value="3" selected>3ëª…</option>
                <option value="4">4ëª…</option>
                <option value="5">5ëª…</option>
                <option value="6">6ëª…</option>
                <option value="7">7ëª…</option>
                <option value="8">8ëª…</option>
                <option value="9">9ëª…</option>
                <option value="10">10ëª…</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    </div>

    <!-- ë¦¬ëª¨ì»¨ ì˜ì—­ -->
    <div class="remote-control" id="remoteControl">
        <div class="remote-header">
            <div class="player-info" id="playerInfo">í”Œë ˆì´ì–´ 1 / 3</div>
        </div>

        <input type="text" class="name-input" id="playerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">

        <div class="number-pad">
            <button class="number-btn" id="btn1" onclick="pressNumber('1')">1</button>
            <button class="number-btn" id="btn2" onclick="pressNumber('2')">2</button>
            <button class="number-btn" id="btn3" onclick="pressNumber('3')">3</button>
            <button class="number-btn" id="btn4" onclick="pressNumber('4')">4</button>
            <button class="number-btn" id="btn5" onclick="pressNumber('5')">5</button>
            <button class="number-btn" id="btn6" onclick="pressNumber('6')">6</button>
            <button class="number-btn" id="btn7" onclick="pressNumber('7')">7</button>
            <button class="number-btn" id="btn8" onclick="pressNumber('8')">8</button>
            <button class="number-btn" id="btn9" onclick="pressNumber('9')">9</button>
            <button class="number-btn" id="btnBackspace" onclick="backspace()">âŒ«</button>
            <button class="number-btn" id="btn0" onclick="pressNumber('0')">0</button>
            <button class="number-btn channel-change" id="btnChannel" onclick="changeChannel()">ì±„ë„<br>ë³€ê²½</button>
        </div>

        <button class="btn-next" id="btnNext" onclick="confirmPlayer()" disabled>ë‹¤ìŒ</button>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div class="result-screen" id="resultScreen">
        <h2>ğŸ† ê²Œì„ ê²°ê³¼</h2>
        <div id="resultList"></div>
        <button class="btn btn-primary" onclick="resetGame()">ê´‘ê³ ë³´ê³  ë‹¤ì‹œë„ì „</button>
    </div>

    <script>
        // ==================== ì„¤ì • ====================
        const MAX_CHANNEL_IMAGES = 72;

        // ==================== ê²Œì„ ë°ì´í„° ====================
        const channelImages = [];
        for (let i = 1; i <= MAX_CHANNEL_IMAGES; i++) {
            const paddedNum = String(i).padStart(4, '0');
            channelImages.push(`channel${paddedNum}.png`);
        }

        // ê¸°ë³¸ í”Œë ˆì´ì–´ ì´ë¦„ (20ê°œ)
        const DEFAULT_PLAYER_NAMES = [
            'ëƒ¥ì½©ì´', 'ëª½ê¸€ëƒ¥', 'ê³ ì–‘ë³„', 'ëƒ¥ë­‰ì¹˜', 'ê¼¬ë¬¼ì´',
            'ë§ë‘ë°œë°”ë‹¥', 'ì†œë°œì´', 'ì½”ì½”ëƒ¥', 'ë³„ëƒ¥ì´', 'êµ¬ë¦„ë°œìêµ­',
            'ì‚´ë‘ì´', 'ì´ˆì½”ê¼¬ë¦¬', 'ë™ê¸€ëƒ¥', 'í•˜ëŠ˜ë°œìêµ­', 'ë‹¬ëƒ¥ì´',
            'ìˆœë‘¥ëƒ¥', 'ëˆˆì†¡ì´ëƒ¥', 'í¬í¬ëƒ¥', 'ê°€ì„ëƒ¥', 'ì´ì´ì´'
        ];

        let totalPlayers = 3;
        let currentPlayerIndex = 0;
        let currentChannel = '';
        let currentImage = '';
        let players = [];
        let catPositions = {};
        let usedImages = [];

        // ==================== ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬ ====================
        function validatePlayerName(name) {
            if (!name || name.trim() === '') {
                return { valid: false, message: 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!' };
            }

            const trimmedName = name.trim();
            const validCharsRegex = /^[ê°€-í£a-zA-Z0-9]+$/;
            if (!validCharsRegex.test(trimmedName)) {
                return { valid: false, message: 'í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!' };
            }

            const koreanChars = trimmedName.match(/[ê°€-í£]/g) || [];
            const otherChars = trimmedName.match(/[a-zA-Z0-9]/g) || [];

            if (koreanChars.length > 0) {
                const totalLength = koreanChars.length + otherChars.length;
                if (totalLength < 2 || totalLength > 10) {
                    return { valid: false, message: 'í•œê¸€ í¬í•¨ ì‹œ 2~10ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!' };
                }
            } else {
                if (otherChars.length < 2 || otherChars.length > 20) {
                    return { valid: false, message: 'ì˜ë¬¸/ìˆ«ìë§Œ ì‚¬ìš© ì‹œ 2~20ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!' };
                }
            }

            return { valid: true, message: '' };
        }

        // ==================== ì´ˆê¸°í™” ====================
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('point/json/pointInfo.json');
                if (response.ok) {
                    catPositions = await response.json();
                    console.log('ê³ ì–‘ì´ ìœ„ì¹˜ ì •ë³´ ë¡œë“œ ì™„ë£Œ');
                }
            } catch (error) {
                console.warn('ê³ ì–‘ì´ ìœ„ì¹˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        });

        // ==================== ê²Œì„ ì‹œì‘ ====================
        function startGame() {
            totalPlayers = parseInt(document.getElementById('playerCount').value);
            currentPlayerIndex = 0;
            players = [];
            usedImages = [];

            document.getElementById('initialScreen').classList.add('slide-out');
            setTimeout(() => {
                document.getElementById('initialScreen').classList.add('hidden');
                document.getElementById('remoteControl').classList.add('slide-in');
                updatePlayerInfo();
                setDefaultPlayerName();
            }, 500);
        }

        // ==================== ê¸°ë³¸ í”Œë ˆì´ì–´ ì´ë¦„ ì„¤ì • ====================
        function setDefaultPlayerName() {
            const nameInput = document.getElementById('playerName');
            if (currentPlayerIndex < DEFAULT_PLAYER_NAMES.length) {
                nameInput.value = DEFAULT_PLAYER_NAMES[currentPlayerIndex];
            } else {
                nameInput.value = `í”Œë ˆì´ì–´${currentPlayerIndex + 1}`;
            }
        }

        // ==================== í”Œë ˆì´ì–´ ì •ë³´ ì—…ë°ì´íŠ¸ ====================
        function updatePlayerInfo() {
            const playerInfo = document.getElementById('playerInfo');
            playerInfo.textContent = `í”Œë ˆì´ì–´ ${currentPlayerIndex + 1} / ${totalPlayers}`;
        }

        // ==================== ë¦¬ëª¨ì»¨ ê¸°ëŠ¥ ====================
        function pressNumber(num) {
            const btn = window.event ? window.event.target : event.target;
            btn.classList.add('pressed');
            setTimeout(() => btn.classList.remove('pressed'), 200);

            if (currentChannel.length < 3) {
                currentChannel += num;
                updateChannelDisplay();
            }
        }

        function backspace() {
            currentChannel = currentChannel.slice(0, -1);
            updateChannelDisplay();
        }

        function updateChannelDisplay() {
            const display = document.getElementById('channelDisplay');
            if (currentChannel.length > 0) {
                display.textContent = currentChannel.padStart(3, '0');
                display.classList.add('active');
            } else {
                display.textContent = '000';
                display.classList.remove('active');
            }
        }

        // ==================== ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ====================
        function setNumberPadEnabled(enabled) {
            const buttons = ['btn1', 'btn2', 'btn3', 'btn4', 'btn5', 'btn6', 'btn7', 'btn8', 'btn9', 'btn0', 'btnBackspace', 'btnChannel'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = !enabled;
            });
        }

        function setNextButtonEnabled(enabled) {
            document.getElementById('btnNext').disabled = !enabled;
        }

        // ==================== ë‹¤ìŒ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ====================
        function updateNextButtonText() {
            const btnNext = document.getElementById('btnNext');
            if (currentPlayerIndex === totalPlayers - 1) {
                btnNext.textContent = 'ê²°ê³¼ í™•ì¸';
            } else {
                btnNext.textContent = 'ë‹¤ìŒ';
            }
        }

        // ==================== ì¹´ìš´í„° ì—…ë°ì´íŠ¸ (íŒ¡ íš¨ê³¼ - ìˆ«ìë§Œ) ====================
        function updateCatCounter(count) {
            const counter = document.getElementById('catCounter');
            counter.textContent = count;
            counter.classList.add('active');

            // íŒ¡ íš¨ê³¼
            counter.classList.remove('pop');
            void counter.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ
            counter.classList.add('pop');
        }

        // ==================== ì±„ë„ ë³€ê²½ ====================
        function changeChannel() {
            const channelNum = parseInt(currentChannel);

            if (!currentChannel || channelNum < 1 || channelNum > 999) {
                alert('ì±„ë„ ë²ˆí˜¸ëŠ” 1~999 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const availableImages = channelImages.filter(img => !usedImages.includes(img));

            if (availableImages.length === 0) {
                alert('ì‚¬ìš© ê°€ëŠ¥í•œ ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤!');
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableImages.length);
            currentImage = availableImages[randomIndex];

            const tvImage = document.getElementById('tvImage');
            tvImage.src = `images/channels/${currentImage}`;
            tvImage.style.display = 'block';

            tvImage.onload = () => {
                displayCatScanAnimation(currentImage);
                setNumberPadEnabled(false);
            };

            tvImage.onerror = () => {
                alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                tvImage.style.display = 'none';
            };
        }

        // ==================== ìŠ¤ìº” ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ê³ ì–‘ì´ ê°ì§€ í‘œì‹œ ====================
        function displayCatScanAnimation(imageName) {
            // ê¸°ì¡´ í„ìŠ¤ì™€ ìŠ¤ìº” ë¼ì¸ ì œê±°
            const existingPulses = document.querySelectorAll('.cat-pulse');
            existingPulses.forEach(pulse => pulse.remove());

            const existingScanLine = document.querySelector('.scan-line');
            if (existingScanLine) existingScanLine.remove();

            if (!catPositions[imageName]) {
                console.warn(`${imageName}ì— ëŒ€í•œ ê³ ì–‘ì´ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            const cats = catPositions[imageName].cats;
            const tvScreen = document.getElementById('tvScreen');

            // ì¹´ìš´í„° ì´ˆê¸°í™” ë° í‘œì‹œ (ì• ë‹ˆë©”ì´ì…˜ ì—†ì´)
            const counter = document.getElementById('catCounter');
            counter.textContent = 0;
            counter.classList.add('active');

            // ìŠ¤ìº” ë¼ì¸ ìƒì„±
            const scanLine = document.createElement('div');
            scanLine.className = 'scan-line';
            tvScreen.appendChild(scanLine);

            let detectedCount = 0;

            // ê° ê³ ì–‘ì´ ìœ„ì¹˜ì— í„ìŠ¤ íš¨ê³¼ ì¶”ê°€ (ìŠ¤ìº” ë¼ì¸ì´ ì§€ë‚˜ê°ˆ ë•Œ)
            cats.forEach((cat, index) => {
                // ìŠ¤ìº” ë¼ì¸ì´ í•´ë‹¹ ìœ„ì¹˜ì— ë„ë‹¬í•˜ëŠ” ì‹œê°„ ê³„ì‚° (2ì´ˆ ë™ì•ˆ 0%ì—ì„œ 100%ë¡œ ì´ë™)
                const delay = cat.x * 2000; // x ì¢Œí‘œì— ë¹„ë¡€í•œ ë”œë ˆì´ (ë°€ë¦¬ì´ˆ)

                setTimeout(() => {
                    const pulse = document.createElement('div');
                    pulse.className = 'cat-pulse';
                    pulse.style.left = `${cat.x * 100}%`;
                    pulse.style.top = `${cat.y * 100}%`;
                    tvScreen.appendChild(pulse);

                    // ì¹´ìš´í„° ì¦ê°€ (íŒ¡ íš¨ê³¼)
                    detectedCount++;
                    updateCatCounter(detectedCount);

                    // í”Œë¡œíŒ… ìˆ«ì í‘œì‹œ ì œê±°ë¨

                    // í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ë©´ ì œê±°
                    setTimeout(() => {
                        pulse.remove();
                    }, 1500);
                }, delay);
            });

            // ìŠ¤ìº” ë¼ì¸ ì œê±° ë° ë‹¤ìŒ ë²„íŠ¼ í™œì„±í™”
            setTimeout(() => {
                scanLine.remove();
                setNextButtonEnabled(true);
                updateNextButtonText();
            }, 2000);
        }

        // ==================== í”Œë ˆì´ì–´ í™•ì • ====================
        function confirmPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const channelNum = parseInt(currentChannel);

            const validation = validatePlayerName(name);
            if (!validation.valid) {
                alert(validation.message);
                return;
            }

            if (!currentChannel || channelNum < 1 || channelNum > 999) {
                alert('ì±„ë„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”! (1~999)');
                return;
            }

            if (!currentImage) {
                alert('ì±„ë„ë³€ê²½ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € í‘œì‹œí•´ì£¼ì„¸ìš”!');
                return;
            }

            const catCount = getCatCount(currentImage);

            players.push({
                name: name,
                channel: currentChannel.padStart(3, '0'),
                catCount: catCount,
                imageName: currentImage
            });

            usedImages.push(currentImage);
            currentPlayerIndex++;

            if (currentPlayerIndex < totalPlayers) {
                resetForNextPlayer();
            } else {
                showResults();
            }
        }

        // ==================== ë‹¤ìŒ í”Œë ˆì´ì–´ ì¤€ë¹„ ====================
        function resetForNextPlayer() {
            currentChannel = '';
            currentImage = '';

            const tvImage = document.getElementById('tvImage');
            tvImage.style.display = 'none';

            // í„ìŠ¤ì™€ ìŠ¤ìº” ë¼ì¸ ì œê±°
            const existingPulses = document.querySelectorAll('.cat-pulse');
            existingPulses.forEach(pulse => pulse.remove());

            const existingScanLine = document.querySelector('.scan-line');
            if (existingScanLine) existingScanLine.remove();

            // ì¹´ìš´í„° ìˆ¨ê¸°ê¸°
            const counter = document.getElementById('catCounter');
            counter.classList.remove('active', 'pop');

            updateChannelDisplay();
            updatePlayerInfo();
            setDefaultPlayerName();
            setNumberPadEnabled(true);
            setNextButtonEnabled(false);
        }

        // ==================== ê³ ì–‘ì´ ê°œìˆ˜ ê³„ì‚° ====================
        function getCatCount(imageName) {
            if (catPositions[imageName] && catPositions[imageName].cats) {
                return catPositions[imageName].cats.length;
            }
            return 0;
        }

        // ==================== ê²°ê³¼ í‘œì‹œ (ìˆ˜ì •ëœ ê³µë™ ë“±ìˆ˜ ì²˜ë¦¬ + ì¸ë„¤ì¼) ====================
        function showResults() {
            players.sort((a, b) => b.catCount - a.catCount);

            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';

            // ê° ì ìˆ˜ë³„ í”Œë ˆì´ì–´ ìˆ˜ ì¹´ìš´íŠ¸
            const scoreCount = {};
            players.forEach(player => {
                scoreCount[player.catCount] = (scoreCount[player.catCount] || 0) + 1;
            });

            let currentRank = 1;
            let previousCount = -1;

            players.forEach((player, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';

                // ë“±ìˆ˜ ì—…ë°ì´íŠ¸
                if (player.catCount !== previousCount) {
                    currentRank = index + 1;
                }
                previousCount = player.catCount;

                // ê°™ì€ ì ìˆ˜ë¥¼ ê°€ì§„ í”Œë ˆì´ì–´ê°€ 2ëª… ì´ìƒì¸ì§€ í™•ì¸
                const isTied = scoreCount[player.catCount] > 1;

                let rankClass = '';
                let rankEmoji = '';
                let rankText = '';

                if (currentRank === 1) {
                    rankClass = 'first';
                    rankEmoji = 'ğŸ¥‡';
                    rankText = isTied ? 'ê³µë™ 1ë“±' : '1ë“±';
                } else if (currentRank === 2) {
                    rankClass = 'second';
                    rankEmoji = 'ğŸ¥ˆ';
                    rankText = isTied ? 'ê³µë™ 2ë“±' : '2ë“±';
                } else if (currentRank === 3) {
                    rankClass = 'third';
                    rankEmoji = 'ğŸ¥‰';
                    rankText = isTied ? 'ê³µë™ 3ë“±' : '3ë“±';
                } else {
                    rankText = isTied ? `ê³µë™ ${currentRank}ë“±` : `${currentRank}ë“±`;
                }

                resultItem.innerHTML = `
                    <div class="result-rank ${rankClass}">
                        ${rankEmoji ? `<span class="rank-emoji">${rankEmoji}</span>` : ''}
                        <span class="rank-text">${rankText}</span>
                    </div>
                    <div class="result-info">
                        <div class="result-name">${player.name}</div>
                        <div class="result-details">
                            <span class="result-channel">ì±„ë„ ${player.channel}</span>
                            <span class="result-score">ğŸ± ${player.catCount}ë§ˆë¦¬</span>
                        </div>
                    </div>
                    <div class="result-thumbnail">
                        <img src="images/channels/${player.imageName}" alt="ì±„ë„ ${player.channel}">
                    </div>
                `;

                resultList.appendChild(resultItem);
            });

            document.getElementById('remoteControl').style.display = 'none';
            document.getElementById('resultScreen').classList.add('active');
        }

        // ==================== ê²Œì„ ë¦¬ì…‹ ====================
        function resetGame() {
            location.reload();
        }
    </script>
</body>

</html>