// Í≤åÏûÑ Î°úÏßÅ Î™®Îìà
import { config } from './config.js';
import { playSound } from './audio.js';

// ==================== Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ ====================
const channelImages = [];
for (let i = 1; i <= config.MAX_CHANNEL_IMAGES; i++) {
    const paddedNum = String(i).padStart(4, '0');
    channelImages.push(`channel${paddedNum}.png`);
}

// Í≥†ÏñëÏù¥ ÏÇ¨Ïö¥Îìú ÌíÄ
let currentCatSoundIndex = 0;

// Í≤åÏûÑ ÏÉÅÌÉú
export let totalPlayers = 3;
export let currentPlayerIndex = 0;
export let currentChannel = '';
export let currentImage = '';
export let players = [];
export let catPositions = {};
export let usedImages = [];
let isGameInitialized = false; // Ï¥àÍ∏∞Ìôî Ï§ëÎ≥µ Î∞©ÏßÄ

/**
 * Í≤åÏûÑ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
 */
export async function initializeGame() {
    if (isGameInitialized) {
        console.log('‚ö†Ô∏è Í≤åÏûÑÏù¥ Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
        return;
    }

    console.log('üéÆ Í≤åÏûÑ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî...');
    isGameInitialized = true;

    // Í≥†ÏñëÏù¥ ÏúÑÏπò Ï†ïÎ≥¥ Î°úÎìú
    try {
        const response = await fetch('point/json/pointInfo.json');
        if (response.ok) {
            catPositions = await response.json();
            console.log('Í≥†ÏñëÏù¥ ÏúÑÏπò Ï†ïÎ≥¥ Î°úÎìú ÏôÑÎ£å');
        }
    } catch (error) {
        console.warn('Í≥†ÏñëÏù¥ ÏúÑÏπò Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
    }

    // Ïª§Ïä§ÌÖÄ ÎìúÎ°≠Îã§Ïö¥ ÏÑ§Ï†ï
    setupCustomDropdown();

    // Í≥†ÏñëÏù¥ Î∞úÏûêÍµ≠ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
    setTimeout(startContinuousWalking, 2000);

    // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (HTMLÏóêÏÑú Ìò∏Ï∂úÏö©)
    window.startGame = startGame;
    window.pressNumber = pressNumber;
    window.backspace = backspace;
    window.changeChannel = changeChannel;
    window.confirmPlayer = confirmPlayer;
    window.resetGame = resetGame;
    window.openInfoPopup = openInfoPopup;
    window.closeInfoPopup = closeInfoPopup;
    window.showCustomAlert = showCustomAlert;
    window.closeCustomAlert = closeCustomAlert;
}

// ==================== Ïù¥Î¶Ñ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ ====================
function validatePlayerName(name) {
    if (!name || name.trim() === '') {
        return { valid: false, message: 'Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!' };
    }

    const trimmedName = name.trim();
    const validCharsRegex = /^[Í∞Ä-Ìû£a-zA-Z0-9]+$/;
    if (!validCharsRegex.test(trimmedName)) {
        return { valid: false, message: 'ÌïúÍ∏Ä, ÏòÅÎ¨∏, Ïà´ÏûêÎßå ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§!' };
    }

    const koreanChars = trimmedName.match(/[Í∞Ä-Ìû£]/g) || [];
    const otherChars = trimmedName.match(/[a-zA-Z0-9]/g) || [];

    if (koreanChars.length > 0) {
        const totalLength = koreanChars.length + otherChars.length;
        if (totalLength < 2 || totalLength > 10) {
            return { valid: false, message: 'ÌïúÍ∏Ä Ìè¨Ìï® Ïãú 2~10ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!' };
        }
    } else {
        if (otherChars.length < 2 || otherChars.length > 20) {
            return { valid: false, message: 'ÏòÅÎ¨∏/Ïà´ÏûêÎßå ÏÇ¨Ïö© Ïãú 2~20ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!' };
        }
    }

    return { valid: true, message: '' };
}

// ==================== Í≤åÏûÑ ÏãúÏûë ====================
export function startGame() {
    // Í≤åÏûÑ ÏãúÏûë ÏÇ¨Ïö¥Îìú
    const gameStartSound = document.getElementById('gameStartSound');
    gameStartSound.currentTime = 0;
    playSound(gameStartSound);

    totalPlayers = parseInt(document.getElementById('playerCount').value);
    currentPlayerIndex = 0;
    players = [];
    usedImages = [];

    document.getElementById('initialScreen').classList.add('slide-out');
    setTimeout(() => {
        document.getElementById('initialScreen').classList.add('hidden');
        const remoteControl = document.getElementById('remoteControl');
        remoteControl.style.display = 'block';
        remoteControl.classList.add('slide-in');
        updatePlayerInfo();
        setDefaultPlayerName();
    }, 500);
}

// ==================== Í∏∞Î≥∏ ÌîåÎ†àÏù¥Ïñ¥ Ïù¥Î¶Ñ ÏÑ§Ï†ï ====================
function setDefaultPlayerName() {
    const nameInput = document.getElementById('playerName');
    if (currentPlayerIndex < config.DEFAULT_PLAYER_NAMES.length) {
        nameInput.value = config.DEFAULT_PLAYER_NAMES[currentPlayerIndex];
    } else {
        nameInput.value = `ÌîåÎ†àÏù¥Ïñ¥${currentPlayerIndex + 1}`;
    }
}

// ==================== ÌîåÎ†àÏù¥Ïñ¥ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ====================
function updatePlayerInfo() {
    const playerInfo = document.getElementById('playerInfo');
    playerInfo.textContent = `ÌîåÎ†àÏù¥Ïñ¥ ${currentPlayerIndex + 1} / ${totalPlayers}`;
}

// ==================== Î¶¨Î™®Ïª® Í∏∞Îä• ====================
export function pressNumber(num) {
    const btn = window.event ? window.event.target : event.target;
    btn.classList.add('pressed');
    setTimeout(() => btn.classList.remove('pressed'), 200);

    if (currentChannel.length === 0 && num === '0') {
        return;
    }

    if (currentChannel.length < 3) {
        currentChannel += num;
        updateChannelDisplay();
    }
}

export function backspace() {
    currentChannel = currentChannel.slice(0, -1);
    updateChannelDisplay();
}

function updateChannelDisplay() {
    const display = document.getElementById('channelDisplay');
    if (currentChannel.length > 0) {
        display.textContent = currentChannel.padStart(3, '0');
        display.classList.add('active');
    } else {
        display.textContent = '000';
        display.classList.remove('active');
    }
}

// ==================== Ï±ÑÎÑê Î≥ÄÍ≤Ω ====================
export function changeChannel() {
    const channelNum = parseInt(currentChannel);

    if (!currentChannel || channelNum < 1 || channelNum > 999) {
        showCustomAlert('Ï±ÑÎÑê Î≤àÌò∏Îäî 1~999 ÏÇ¨Ïù¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
        return;
    }

    const usedChannels = players.map(p => p.channel);
    if (usedChannels.includes(currentChannel.padStart(3, '0'))) {
        showCustomAlert(`Ï±ÑÎÑê ${currentChannel.padStart(3, '0')}Î≤àÏùÄ Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§!\n\nÏÇ¨Ïö©Îêú Ï±ÑÎÑê: ${usedChannels.join(', ')}`);
        return;
    }

    const availableImages = channelImages.filter(img => !usedImages.includes(img));

    if (availableImages.length === 0) {
        showCustomAlert('ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïù¥ÎØ∏ÏßÄÍ∞Ä Î™®Îëê ÏÜåÏßÑÎêòÏóàÏäµÎãàÎã§!');
        return;
    }

    const randomIndex = Math.floor(Math.random() * availableImages.length);
    currentImage = availableImages[randomIndex];

    const tvImage = document.getElementById('tvImage');
    tvImage.src = `images/channels/${currentImage}`;
    tvImage.style.display = 'block';

    tvImage.onload = () => {
        displayCatScanAnimation(currentImage);
        setNumberPadEnabled(false);
    };

    tvImage.onerror = () => {
        showCustomAlert('Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§!');
        tvImage.style.display = 'none';
    };
}

// ==================== Ïä§Ï∫î Ïï†ÎãàÎ©îÏù¥ÏÖò ====================
function displayCatScanAnimation(imageName) {
    // Í∏∞Ï°¥ ÌéÑÏä§ÏôÄ Ïä§Ï∫î ÎùºÏù∏ Ï†úÍ±∞
    const existingPulses = document.querySelectorAll('.cat-pulse');
    existingPulses.forEach(pulse => pulse.remove());

    const existingScanLine = document.querySelector('.scan-line');
    if (existingScanLine) existingScanLine.remove();

    if (!catPositions[imageName]) {
        console.warn(`${imageName}Ïóê ÎåÄÌïú Í≥†ÏñëÏù¥ ÏúÑÏπò Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.`);
        setNumberPadEnabled(true);
        setNextButtonEnabled(true);
        updateNextButtonText();
        return;
    }

    const cats = catPositions[imageName].cats || [];
    const tvScreen = document.getElementById('tvScreen');
    const scanSound = document.getElementById('scanSound');
    const catSoundPool = Array.from(document.querySelectorAll('.catSound'));

    updateCatCounter(0);

    scanSound.currentTime = 0;
    playSound(scanSound);

    const scanLine = document.createElement('div');
    scanLine.className = 'scan-line';
    tvScreen.appendChild(scanLine);

    let animationTime = 2000;
    scanLine.style.animation = `scanMove ${animationTime}ms cubic-bezier(0.25, 0.1, 0.25, 1.0) forwards`;

    setTimeout(() => {
        scanLine.remove();
        scanSound.pause();
        scanSound.currentTime = 0;

        if (cats.length === 0) {
            updateCatCounter(0);
            setNumberPadEnabled(true);
            setNextButtonEnabled(true);
            updateNextButtonText();
            const name = document.getElementById('playerName').value.trim();
            const validation = validatePlayerName(name);

            if (!validation.valid) {
                showCustomAlert(validation.message);
                return;
            }

            if (!currentChannel || !currentImage) {
                showCustomAlert('Ï±ÑÎÑêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            const catCount = catPositions[currentImage]?.cats?.length || 0;

            players.push({
                name: name,
                channel: currentChannel.padStart(3, '0'),
                imageName: currentImage,
                catCount: catCount
            });

            usedImages.push(currentImage);

            if (currentPlayerIndex < totalPlayers - 1) {
                currentPlayerIndex++;
                currentChannel = '';
                currentImage = '';

                document.getElementById('tvImage').style.display = 'none';
                updatePlayerInfo();
                setDefaultPlayerName();

                const catCounter = document.getElementById('catCounter');
                catCounter.classList.remove('active', 'pop');
                catCounter.textContent = '0';

                const channelDisplay = document.getElementById('channelDisplay');
                channelDisplay.classList.remove('active');
                channelDisplay.textContent = '000';

                const existingPulses = document.querySelectorAll('.cat-pulse');
                existingPulses.forEach(pulse => pulse.remove());

                setNumberPadEnabled(true);
                setNextButtonEnabled(false);
                updateNextButtonText();
            } else {
                showResults();
            }
        }

        // ==================== Í≤∞Í≥º ÌëúÏãú ====================
        function showResults() {
            const gameEndSound = document.getElementById('gameEndSound');
            gameEndSound.currentTime = 0;
            playSound(gameEndSound);

            players.sort((a, b) => b.catCount - a.catCount);

            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';

            let currentRank = 1;
            let previousCatCount = -1;
            let sameRankCount = 0;

            players.forEach((player, index) => {
                const isTied = player.catCount === previousCatCount;

                if (!isTied) {
                    currentRank += sameRankCount;
                    sameRankCount = 1;
                } else {
                    sameRankCount++;
                }

                previousCatCount = player.catCount;

                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';

                let rankClass = '';
                let rankEmoji = '';
                let rankText = `${currentRank}Îì±`;

                if (currentRank === 1) {
                    rankClass = 'first';
                    rankEmoji = 'ü•á';
                    rankText = isTied ? 'Í≥µÎèô 1Îì±' : '1Îì±';
                } else if (currentRank === 2) {
                    rankClass = 'second';
                    rankEmoji = 'ü•à';
                    rankText = isTied ? 'Í≥µÎèô 2Îì±' : '2Îì±';
                } else if (currentRank === 3) {
                    rankClass = 'third';
                    rankEmoji = 'ü•â';
                    rankText = isTied ? 'Í≥µÎèô 3Îì±' : '3Îì±';
                } else {
                    rankText = isTied ? `Í≥µÎèô ${currentRank}Îì±` : `${currentRank}Îì±`;
                }

                resultItem.innerHTML = `
      <div class="result-rank ${rankClass}">
        ${rankEmoji ? `<span class="rank-emoji">${rankEmoji}</span>` : ''}
        <span class="rank-text">${rankText}</span>
      </div>
      <div class="result-info">
        <div class="result-name">${player.name}</div>
        <div class="result-details">
          <span class="result-channel">Ï±ÑÎÑê ${player.channel}</span>
          <span class="result-score">üê± ${player.catCount}ÎßàÎ¶¨</span>
        </div>
      </div>
      <div class="result-thumbnail">
        <img src="images/channels/${player.imageName}" alt="Ï±ÑÎÑê ${player.channel}">
      </div>
    `;

                resultList.appendChild(resultItem);
            });

            document.getElementById('remoteControl').style.display = 'none';
            document.getElementById('resultScreen').classList.add('active');
        }

        // ==================== Í≤åÏûÑ Î¶¨ÏÖã ====================
        export function resetGame() {
            totalPlayers = 3;
            currentPlayerIndex = 0;
            currentChannel = '';
            currentImage = '';
            players = [];
            usedImages = [];

            document.getElementById('resultScreen').classList.remove('active');
            document.getElementById('remoteControl').style.display = 'none';
            document.getElementById('remoteControl').classList.remove('slide-in');
            document.getElementById('initialScreen').classList.remove('slide-out', 'hidden');

            const tvImage = document.getElementById('tvImage');
            tvImage.style.display = 'none';
            tvImage.src = '';
            tvImage.onload = null;
            tvImage.onerror = null;

            const counter = document.getElementById('catCounter');
            counter.classList.remove('active', 'pop');
            counter.textContent = '0';

            const channelDisplay = document.getElementById('channelDisplay');
            channelDisplay.classList.remove('active');
            channelDisplay.textContent = '000';

            document.getElementById('playerCount').value = '3';
            document.getElementById('playerName').value = '';

            setNumberPadEnabled(true);
            setNextButtonEnabled(false);

            const existingPulses = document.querySelectorAll('.cat-pulse');
            existingPulses.forEach(pulse => pulse.remove());

            const existingScanLine = document.querySelector('.scan-line');
            if (existingScanLine) existingScanLine.remove();
        }

        // ==================== Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî ====================
        function setNumberPadEnabled(enabled) {
            const buttons = ['btn1', 'btn2', 'btn3', 'btn4', 'btn5', 'btn6', 'btn7', 'btn8', 'btn9', 'btn0', 'btnBackspace', 'btnChannel'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = !enabled;
            });
        }

        function setNextButtonEnabled(enabled) {
            document.getElementById('btnNext').disabled = !enabled;
        }

        function updateNextButtonText() {
            const btnNext = document.getElementById('btnNext');
            if (currentPlayerIndex === totalPlayers - 1) {
                btnNext.textContent = 'Í≤∞Í≥º ÌôïÏù∏';
            } else {
                btnNext.textContent = 'Îã§Ïùå';
            }
        }

        function updateCatCounter(count) {
            const counter = document.getElementById('catCounter');
            counter.textContent = count;
            counter.classList.add('active');

            counter.classList.remove('pop');
            void counter.offsetWidth;
            counter.classList.add('pop');
        }

        // ==================== ÌåùÏóÖ ====================
        export function openInfoPopup() {
            const popup = document.getElementById('infoPopup');
            popup.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        export function closeInfoPopup() {
            const popup = document.getElementById('infoPopup');
            popup.classList.remove('active');
            document.body.style.overflow = '';
        }

        export function showCustomAlert(message) {
            const overlay = document.getElementById('customAlertOverlay');
            const messageEl = document.getElementById('customAlertMessage');
            messageEl.textContent = message;
            overlay.classList.add('active');
        }

        export function closeCustomAlert() {
            const overlay = document.getElementById('customAlertOverlay');
            overlay.classList.remove('active');
        }

        // ==================== Ïª§Ïä§ÌÖÄ ÎìúÎ°≠Îã§Ïö¥ ====================
        let isDropdownInitialized = false; // Ï§ëÎ≥µ Ï¥àÍ∏∞Ìôî Î∞©ÏßÄ

        function setupCustomDropdown() {
            if (isDropdownInitialized) {
                console.log('‚ö†Ô∏è ÎìúÎ°≠Îã§Ïö¥Ïù¥ Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                return;
            }

            const customDropdown = document.getElementById('customDropdown');
            const dropdownButton = document.getElementById('dropdownButton');
            const dropdownList = document.getElementById('dropdownList');
            const dropdownValue = document.getElementById('dropdownValue');
            const nativeSelect = document.getElementById('playerCount');

            if (dropdownButton) {
                dropdownButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    customDropdown.classList.toggle('open');
                });
            }

            if (dropdownList) {
                dropdownList.addEventListener('click', (e) => {
                    if (e.target.classList.contains('custom-dropdown-option')) {
                        const value = e.target.getAttribute('data-value');
                        const text = e.target.textContent;

                        dropdownValue.textContent = text;
                        nativeSelect.value = value;

                        document.querySelectorAll('.custom-dropdown-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        e.target.classList.add('selected');

                        customDropdown.classList.remove('open');
                    }
                });
            }

            document.addEventListener('click', () => {
                if (customDropdown) {
                    customDropdown.classList.remove('open');
                }
            });

            const selectedOption = document.querySelector('.custom-dropdown-option[data-value="3"]');
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            isDropdownInitialized = true;
        }

        // ==================== Í≥†ÏñëÏù¥ Î∞úÏûêÍµ≠ Ïï†ÎãàÎ©îÏù¥ÏÖò ====================
        function createPawPrint(x, y, rotation = 0) {
            const tvScreen = document.querySelector('.tv-screen');
            if (tvScreen) {
                const tvRect = tvScreen.getBoundingClientRect();
                const pawSize = 50;

                if (x + pawSize > tvRect.left &&
                    x < tvRect.right &&
                    y + pawSize > tvRect.top &&
                    y < tvRect.bottom) {
                    return;
                }
            }

            const container = document.getElementById('pawPrintsContainer');
            const paw = document.createElement('div');
            paw.className = 'paw-print';
            paw.style.left = `${x}px`;
            paw.style.top = `${y}px`;
            paw.style.transform = `rotate(${rotation}deg) scaleX(-1)`;

            container.appendChild(paw);

            setTimeout(() => {
                paw.remove();
            }, 8000);
        }

        let catPosition = { x: 0, y: 0 };
        let catAngle = 0;
        let isWalking = false;

        function initializeCatPosition() {
            catPosition.x = window.innerWidth / 2 + (Math.random() - 0.5) * 200;
            catPosition.y = window.innerHeight / 2 + (Math.random() - 0.5) * 200;
            catAngle = Math.random() * 360;
        }

        function getNextDirection() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const margin = 100;

            if (catPosition.x < margin) {
                catAngle = -45 + Math.random() * 90;
            } else if (catPosition.x > screenWidth - margin) {
                catAngle = 135 + Math.random() * 90;
            } else if (catPosition.y < margin) {
                catAngle = 45 + Math.random() * 90;
            } else if (catPosition.y > screenHeight - margin) {
                catAngle = 225 + Math.random() * 90;
            } else {
                catAngle += (Math.random() - 0.5) * 90;
            }

            catAngle = ((catAngle % 360) + 360) % 360;
        }

        function createContinuousPawTrail() {
            const pawCount = 8;
            const stepSize = 45;
            const stepWidth = 12;

            getNextDirection();

            const rad = (catAngle * Math.PI) / 180;

            for (let i = 0; i < pawCount; i++) {
                setTimeout(() => {
                    const side = (i % 2 === 0) ? -1 : 1;
                    const offsetX = Math.cos(rad) * stepSize * i + Math.sin(rad) * stepWidth * side;
                    const offsetY = Math.sin(rad) * stepSize * i - Math.cos(rad) * stepWidth * side;

                    const x = catPosition.x + offsetX;
                    const y = catPosition.y + offsetY;

                    const rotation = catAngle + 90 + (Math.random() - 0.5) * 10;

                    createPawPrint(x, y, rotation);

                    if (i === pawCount - 1) {
                        catPosition.x = x;
                        catPosition.y = y;
                    }
                }, i * 250);
            }
        }

        function startContinuousWalking() {
            if (!isWalking) {
                initializeCatPosition();
                isWalking = true;
            }

            createContinuousPawTrail();

            setTimeout(startContinuousWalking, 1800);
        }
